module CVE_2021_41773;

@if (include_data_in_notice)
    event handle_http_entity_data(f: fa_file, data: string)
        {
        local c: connection;
        for (cid in f$conns)
            {
            c = f$conns[cid];
            if (!c?$http)
                next;
            if (! c$http?$CVE_2021_41773_analyzed_traffic_length)
                c$http$CVE_2021_41773_analyzed_traffic_length = 0;

            c$http$CVE_2021_41773_analyzed_traffic_length += |data|;

            if (c$http$CVE_2021_41773_analyzed_traffic_length > http_body_analysis_byte_depth)
                Files::remove_analyzer(f, Files::ANALYZER_DATA_EVENT, [$stream_event=handle_http_entity_data]);

            event CVE_2021_41773::faster_http_entity_data(c, f$is_orig, data);
            }
        }

    event file_over_new_connection(f: fa_file, c: connection, is_orig: bool)
        {
        if (!c?$http)
            return;
        if (!c$http?$CVE_2021_41773_original_URI)
            return;
        if (c$http?$method)
            Files::add_analyzer(f, Files::ANALYZER_DATA_EVENT, [$stream_event=handle_http_entity_data]);
        }

@endif