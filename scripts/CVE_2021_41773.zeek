module CVE_2021_41773;

event http_request(c: connection, method: string, original_URI: string, unescaped_URI: string, version: string)
    {
    if (c$http$trans_depth > 1)
        return;
    if (original_URI != unescaped_URI)
        { 
        if (path_traversal_encoded in original_URI)
            c$http$CVE_2021_41773_original_URI = original_URI;
        }
    }

@if (include_data_in_notice)
    event CVE_2021_41773::faster_http_entity_data(c: connection, is_orig: bool, data: string)
        {
            if (!is_orig)
                return;
            if (!c$http?$CVE_2021_41773_original_URI)
                return;
            # If we have a sample already, return
            if(|c$http$CVE_2021_41773_payload_sample| > 0)
                return;
            c$http$CVE_2021_41773_payload_sample = sub_bytes(data,0,http_body_analysis_byte_depth);
        }
@endif

event http_header(c: connection, is_orig: bool, name: string, value: string)
    {
     # if the preceeding client request isn't a path traversal candidate, return 
    if (!c$http?$CVE_2021_41773_original_URI)
        return;
    # We are only interested in Server headers, as these contain the Server version.
    if (is_orig)
        return;
    if (name == "SERVER")
        {
        # c$http$found=T;
        if (vulnerable_version in value)
            {
            NOTICE([$note=PATH_TRAVERSAL_IS_VULNERABLE,
                    $conn=c, 
                    $identifier=cat(c$id$orig_h,c$id$resp_h,c$id$resp_p,cat(c$http$CVE_2021_41773_original_URI)),
                    # $suppress_for=3600sec,
                    $msg=fmt("Possible Apache 2.4.49 or 2.4.50 path traversal exploit CVE-2021-41773. Refer to https://httpd.apache.org/security/vulnerabilities_24.html#CVE-2021-41773. Refer to sub field for sample of payload, original_URI and list of server headers"),
                    $sub=fmt("payload sample (first %s bytes of POST)='%s', original_URI='%s', Server header value='%s'", http_body_analysis_byte_depth, c$http$CVE_2021_41773_payload_sample, c$http$CVE_2021_41773_original_URI, value)]);
            }
        }
    }
